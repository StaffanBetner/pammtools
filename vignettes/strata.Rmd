---
title: "Stratified baseline"
author: "Andreas Bender"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{strata}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: pam.bib
---

```{r, echo = FALSE}
library(knitr)
opts_chunk$set(
  fig.align  = "center",
  cache      = TRUE,
  message    = FALSE,
  fig.height = 5,
  fig.width  = 5
)
```

```{r}
library(magrittr)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
library(mgcv)
library(survival)
library(pam)
```

# Stratified baselines 

In some cases the proportional hazards assumption for different groups 
(levels of a factor variable) is violated. One approach to resolve this 
problem is to fit a so called *stratified* Cox model, where each level 
$k=1,\ldots,K$ of factor variable $z$ will have its own baseline-hazard: 

$\lambda(t|z, x)=\lambda_{0k}(t, z)\exp(x'\beta)$. 

For illustration we again use the veterans data from the `survival` package:

```{r, warning=FALSE}
data("veteran")
veteran %<>% filter(time < 400)
table(veteran$celltype)
cph <- coxph(Surv(time, status) ~ strata(celltype), data=veteran)
base <- basehaz(cph, centered=FALSE)
gg.bz <- ggplot(base, aes(x=time, y=hazard, group=strata)) + 
	geom_step() + 
	ylab(expression(Lambda(t))) + xlab("t")
gg.bz
```

We can obtain similar results with PAMs by fitting one smooth baseline 
estimate for each category of `celltype` in the data. 
Technically, we specify the `by` argument in `mgcv` `s(...)` function:

```{r, fig.width=7, fig.height=6, warning=FALSE}
ped <- split_data(Surv(time, status)~., data=veteran, id="id")
pam <- gam(ped_status ~ celltype + s(tend, by=celltype), data=ped, 
	family=poisson(), offset=offset)
pinf <- ped %>% group_by(celltype) %>% ped_info() %>% add_cumhazard(pam) %>% 
	rename(strata=celltype)
gg.bz +	
	geom_line(data=pinf, aes(x=tend, y=cumhazard, group=strata, col="PAM")) + 
	facet_wrap(~strata) + 
	scale_color_brewer(name="Method", palette="Set1") +
	ylim(c(0, 5))
```