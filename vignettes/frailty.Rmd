---
title: "Frailty and random effects"
author: "Andreas Bender"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{frailty}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: pam.bib
---

```{r, echo = FALSE}
library(knitr)
opts_chunk$set(
  fig.align = "center",
  fig.width = 4, 
  fig.height = 4,
  crop=TRUE)
```

```{r message=FALSE}
library(magrittr)
library(dplyr)
library(survival)
library(coxme)
library(pam)
library(mgcv)
```

In some cases, when subjects observed from one cluster or group are assumed 
to have correlated outcomes, we can account for such correlation structure 
by including random effects in our model. In the context of survival analysis 
such effects are called "frailty" terms. 

## NCCTG Lung Cancer Data
For illustration we consider the NCTG Lung Cancer Data [@Loprinzi1994] that 
is contained in the `survival` package [@Thernau2015] and description 
of the data is provided in `?lung`

In essense we have survival times (in days) of advanced lung cancer patients 
from different Insitutes: 

```{r}
lung %<>% mutate(inst = as.factor(inst))
head(lung)

## 228 patients from 18 institutes
nrow(lung)
lung %>% group_by(inst) %>% summarize(n=n())
```


## Cox model with gaussian frailty 
The penalized Cox model with frailty terms has been described in @Thernau2003
and implemented in the `coxme` package for gaussian frailties. 
Below we apply the `coxme` function to the `lung` data:

```{r}
cme <- coxme(Surv(time, status) ~ ph.ecog + (1|inst), data=lung)
coef(cme)
summary(cme$frail$inst)
```

- The effect of `ph.ecog` was estimated to be about `0.5` on the log-hazard scale. 
- The random intercepts of the different institution are relatively close to zero
and have small variance. 

## PAM with gaussian frailty

For an equivalent model using PAMs we first transform the data set and 
then call `mgcv:::gam` for the fit. To include a gaussian random effect 
we set the `bs` argument in the `s()` term to `bs='re'` (see description 
in `?smooth.terms`): 

```{r}
ped <- split_data(Surv(time, status)~., data=lung, id="id")
pam <- gam(ped_status ~ s(tend) + ph.ecog + s(inst, bs="re"), 
	data=ped, family=poisson(), offset=offset)
```

Comparison of the estimates of the two models shows that they are in good 
agreement (we use `tidy_re` from the `pam` package to extract random effects):

```{r}
cbind(pam = coef(pam)[2], cox=coef(cme))
re <- tidy_re(pam)
plot(cme$frail$inst, re$fit, las=1, xlab="Frailty (cox)", ylab="Frailty (PAM)")
abline(0, 1)
```

The `pam` package also provides a convenience function to plot the random effects: 

```{r}
gg_re(pam)
```




## References 